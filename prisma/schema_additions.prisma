// ============================================
// EDUCATION CRM - GROUP & PAYMENT MANAGEMENT
// ============================================

// Teacher model - O'qituvchilar
model Teacher {
  id          Int      @id @default(autoincrement())
  centerId    Int
  userId      Int?     // Optional link to User table
  
  // Teacher information
  firstName   String
  lastName    String
  phoneNumber String
  email       String?
  specialty   String?  // Mutaxassisligi
  bio         String?  @db.Text
  
  // Status
  isActive    Boolean  @default(true)
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  groupTeachers GroupTeacher[]

  @@index([centerId])
  @@index([userId])
  @@index([isDeleted])
  @@map("teachers")
}

// Student model - O'quvchilar
model Student {
  id          Int      @id @default(autoincrement())
  centerId    Int
  userId      Int?     // Optional link to User table
  
  // Student information
  firstName   String
  lastName    String
  phoneNumber String
  email       String?
  telegramUsername String?
  
  // Status
  isActive    Boolean  @default(true)
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  groupStudents    GroupStudent[]
  payments         Payment[]
  freezeRequests   StudentFreeze[]
  refundRequests   RefundRequest[]

  @@index([centerId])
  @@index([userId])
  @@index([phoneNumber])
  @@index([isDeleted])
  @@map("students")
}

// Group model - Guruhlar
model Group {
  id              Int      @id @default(autoincrement())
  centerId        Int
  
  // Group information
  name            String
  description     String?  @db.Text
  monthlyFee      Decimal  @db.Decimal(10, 2)  // Oylik to'lov
  
  // Course dates
  courseStartDate DateTime
  courseEndDate   DateTime
  
  // Payment configuration
  paymentType     PaymentType  // MONTHLY_SAME_DATE, START_TO_END_OF_MONTH, LESSON_BASED
  
  // For LESSON_BASED payment type
  lessonsPerPaymentPeriod Int?  // Bir to'lov davridagi darslar soni
  
  // Discount for upfront payment
  hasUpfrontDiscount Boolean @default(false)
  upfrontDiscountPercent Decimal? @db.Decimal(5, 2)  // Masalan: 10.00 = 10%
  
  // Join link
  joinLink        String   @unique  // Telegram orqali ulashish uchun link
  
  // Status
  isActive        Boolean  @default(true)
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  groupTeachers   GroupTeacher[]
  groupStudents   GroupStudent[]
  lessonSchedules LessonSchedule[]
  payments        Payment[]

  @@index([centerId])
  @@index([joinLink])
  @@index([isDeleted])
  @@map("groups")
}

// GroupTeacher - Guruh va o'qituvchilar o'rtasidagi many-to-many
model GroupTeacher {
  id        Int      @id @default(autoincrement())
  groupId   Int
  teacherId Int
  
  // Role in this group
  isPrimary Boolean  @default(false)  // Asosiy o'qituvchi
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([groupId, teacherId])
  @@index([groupId])
  @@index([teacherId])
  @@map("group_teachers")
}

// LessonSchedule - Dars jadvali
model LessonSchedule {
  id        Int      @id @default(autoincrement())
  groupId   Int
  
  // Day of week (1 = Monday, 7 = Sunday)
  dayOfWeek Int
  
  // Lesson time
  startTime String   // Format: "HH:MM" (e.g., "09:00")
  endTime   String   // Format: "HH:MM" (e.g., "10:30")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@map("lesson_schedules")
}

// GroupStudent - Talaba guruhga qo'shilishi
model GroupStudent {
  id              Int      @id @default(autoincrement())
  groupId         Int
  studentId       Int
  
  // Enrollment information
  joinedAt        DateTime @default(now())
  enrollmentDate  DateTime @default(now())  // Qachon guruhga qo'shilgan
  
  // Status
  status          GroupStudentStatus @default(ACTIVE)  // ACTIVE, FROZEN, REMOVED, COMPLETED
  
  // Payment tracking
  lastPaymentDate DateTime?
  nextPaymentDate DateTime?
  
  // Upfront payment
  paidUpfront     Boolean  @default(false)  // To'liq to'lagan
  upfrontMonths   Int?     // Necha oylik to'lagan
  
  // Removal tracking
  removedAt       DateTime?
  removalReason   String?  // AUTO_NONPAYMENT, MANUAL, STUDENT_REQUEST, etc.
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  group          Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student        Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  freezeRequests StudentFreeze[]

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@index([status])
  @@index([nextPaymentDate])
  @@index([isDeleted])
  @@map("group_students")
}

// Payment - To'lovlar
model Payment {
  id              Int      @id @default(autoincrement())
  centerId        Int
  groupId         Int
  studentId       Int
  groupStudentId  Int?     // Link to GroupStudent
  
  // Payment information
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("UZS")
  
  // Payment period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Payment type for this specific payment
  paymentType     PaymentType
  
  // For LESSON_BASED payments
  lessonsIncluded Int?     // Bu to'lovga nechta dars kiradi
  lessonPrice     Decimal? @db.Decimal(10, 2)  // Bir dars narxi
  
  // Status
  status          PaymentStatus @default(PENDING)  // PENDING, PAID, OVERDUE, CANCELLED, REFUNDED
  
  // Payment dates
  dueDate         DateTime
  paidAt          DateTime?
  
  // Payment method
  paymentMethod   String?  // CASH, CARD, BANK_TRANSFER, etc.
  
  // Notification tracking
  notificationSent Boolean  @default(false)
  notificationSentAt DateTime?
  
  // Overdue tracking
  overdueNoticeSent Boolean @default(false)
  overdueNoticeSentAt DateTime?
  daysOverdue     Int      @default(0)
  
  // Notes
  notes           String?  @db.Text
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([groupId])
  @@index([studentId])
  @@index([status])
  @@index([dueDate])
  @@index([isDeleted])
  @@map("payments")
}

// StudentFreeze - Talabani muzlatish
model StudentFreeze {
  id              Int      @id @default(autoincrement())
  groupStudentId  Int
  studentId       Int
  
  // Freeze information
  reason          String   @db.Text
  freezeStartDate DateTime
  freezeEndDate   DateTime?  // null = indefinite freeze
  
  // Status
  status          FreezeStatus @default(ACTIVE)  // ACTIVE, ENDED, CANCELLED
  
  // End tracking
  actualEndDate   DateTime?
  endedBy         String?  // STUDENT, ADMIN, AUTO
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  groupStudent GroupStudent @relation(fields: [groupStudentId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([groupStudentId])
  @@index([studentId])
  @@index([status])
  @@index([freezeStartDate])
  @@index([isDeleted])
  @@map("student_freezes")
}

// RefundRequest - Qaytarish so'rovi
model RefundRequest {
  id              Int      @id @default(autoincrement())
  centerId        Int
  studentId       Int
  groupId         Int
  
  // Refund information
  requestReason   String   @db.Text
  totalPaid       Decimal  @db.Decimal(10, 2)  // Jami to'langan summa
  lessonsAttended Int      // Qatnashgan darslar soni
  totalLessons    Int      // Jami darslar soni
  
  // Calculated refund
  refundAmount    Decimal  @db.Decimal(10, 2)  // Qaytariladigan summa
  
  // Status
  status          RefundStatus @default(PENDING)  // PENDING, APPROVED, REJECTED, COMPLETED
  
  // Processing
  processedBy     Int?     // Admin user ID
  processedAt     DateTime?
  processingNotes String?  @db.Text
  
  // Completion
  completedAt     DateTime?
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([studentId])
  @@index([groupId])
  @@index([status])
  @@index([isDeleted])
  @@map("refund_requests")
}

// PaymentNotification - To'lov haqida xabarnomalar
model PaymentNotification {
  id              Int      @id @default(autoincrement())
  centerId        Int
  studentId       Int
  paymentId       Int?
  
  // Notification information
  notificationType NotificationType  // PAYMENT_DUE, PAYMENT_OVERDUE, PAYMENT_REMINDER
  
  // Message
  message         String   @db.Text
  
  // Delivery
  deliveryMethod  String   // TELEGRAM, SMS, EMAIL
  deliveryStatus  DeliveryStatus @default(PENDING)  // PENDING, SENT, FAILED, DELIVERED
  
  // Tracking
  sentAt          DateTime?
  deliveredAt     DateTime?
  failureReason   String?
  
  // Retry
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([centerId])
  @@index([studentId])
  @@index([paymentId])
  @@index([deliveryStatus])
  @@index([sentAt])
  @@map("payment_notifications")
}

// PaymentSchedule - To'lov jadvali (future payments)
model PaymentSchedule {
  id              Int      @id @default(autoincrement())
  centerId        Int
  groupId         Int
  studentId       Int
  groupStudentId  Int
  
  // Schedule information
  scheduledDate   DateTime  // Qachon to'lov kutilmoqda
  amount          Decimal   @db.Decimal(10, 2)
  
  // Period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Status
  status          ScheduleStatus @default(SCHEDULED)  // SCHEDULED, GENERATED, CANCELLED
  
  // Generated payment tracking
  paymentId       Int?      // Generated payment ID
  generatedAt     DateTime?
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([centerId])
  @@index([groupId])
  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
  @@index([isDeleted])
  @@map("payment_schedules")
}

// ============================================
// ENUMS
// ============================================

enum PaymentType {
  MONTHLY_SAME_DATE        // From start date to same date next month
  START_TO_END_OF_MONTH    // From start to end of month, then full months
  LESSON_BASED             // Based on number of lessons
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum GroupStudentStatus {
  ACTIVE
  FROZEN
  REMOVED
  COMPLETED
}

enum FreezeStatus {
  ACTIVE
  ENDED
  CANCELLED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum NotificationType {
  PAYMENT_DUE
  PAYMENT_OVERDUE
  PAYMENT_REMINDER
  FREEZE_APPROVED
  FREEZE_ENDED
  REFUND_PROCESSED
  GROUP_REMOVED
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
}

enum ScheduleStatus {
  SCHEDULED
  GENERATED
  CANCELLED
}
