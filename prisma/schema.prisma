// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Center (Tenant) - Multi-tenant architecture
model Center {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  logoUrl     String?
  isActive    Boolean  @default(true)
  ownerUserId Int?
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  ownerUser       User?                 @relation("CenterOwner", fields: [ownerUserId], references: [id])
  users           User[]                @relation("CenterUsers")
  activeUsers     User[]                @relation("ActiveCenter")
  userCenters     UserCenter[]          // Center bir nechta userga tegishli bo'lishi mumkin
  roles           Role[]
  bots            CenterTelegramBot[]
  paymentCards    CenterPaymentCard[]
  subscriptions   CenterSubscription[]

  @@index([ownerUserId])
  @@index([isDeleted])
  @@map("centers")
}

// User model - Asosiy user entity (Admin, Teacher, Student)
model User {
  id            Int       @id @default(autoincrement())
  username      String?   @unique
  password      String?              // Optional for Telegram-only users
  firstName     String?
  lastName      String?
  phoneNumber   String    @unique    // Required for phone-based authentication
  
  // User type and authentication
  userType      UserType  @default(STUDENT)  // ADMIN, TEACHER, STUDENT
  authProvider  String    @default("local")   // local, telegram, google
  
  // Status
  isActive      Boolean   @default(true)
  
  // Multi-tenant
  centerId      Int
  activeCenterId Int?    // Hozir qaysi centerda ishlayotgani
  
  // Telegram integration (optional link)
  telegramUserId Int?     @unique
  botLinkToken   String?  @unique  // One-time token for bot linking
  
  // Soft delete
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  center         Center          @relation("CenterUsers", fields: [centerId], references: [id], onDelete: Cascade)
  activeCenter   Center?         @relation("ActiveCenter", fields: [activeCenterId], references: [id], onDelete: SetNull)
  ownedCenters   Center[]        @relation("CenterOwner")
  userCenters    UserCenter[]    // User bir nechta centerga tegishli bo'lishi mumkin
  userRoles      UserRole[]
  refreshTokens  RefreshToken[]
  telegramUser   TelegramUser?   @relation(fields: [telegramUserId], references: [id])
  teachers       Teacher[]       // Teacher profiles linked to this user
  students       Student[]       // Student profiles linked to this user

  @@index([centerId])
  @@index([activeCenterId])
  @@index([phoneNumber])
  @@index([telegramUserId])
  @@index([userType])
  @@index([isDeleted])
  @@map("users")
}

// Role model
model Role {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String
  description String?
  isSystem    Boolean  @default(false)
  centerId    Int
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  center          Center           @relation(fields: [centerId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([slug, centerId])
  @@index([centerId])
  @@index([isDeleted])
  @@map("roles")
}

// Permission model
model Permission {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  module      String
  action      String
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@index([module])
  @@index([isDeleted])
  @@map("permissions")
}

// UserRole junction table
model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int
  roleId    Int
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// RolePermission junction table
model RolePermission {
  id           Int      @id @default(autoincrement())
  roleId       Int
  permissionId Int
  createdAt    DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// RefreshToken for JWT authentication
model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// TelegramUser - Telegram-specific data
model TelegramUser {
  id           Int      @id @default(autoincrement())
  telegramId   String   @unique  // Telegram user ID (globally unique)
  centerId     Int?                // Optional: qaysi center'dan kelgan
  
  // Telegram-specific fields
  username     String?
  firstName    String?
  lastName     String?
  chatId       String?
  phoneNumber  String?
  languageCode String?
  isBot        Boolean  @default(false)
  
  // Bot state tracking
  userStep     String?  // Current step in conversation flow (e.g., "enter_name", "select_payment")
  
  // Status
  isActive     Boolean  @default(true)
  status       String?  @default("active") // active, blocked, pending_payment
  
  // Additional data
  metadata     Json?
  
  // Soft delete
  isDeleted    Boolean  @default(false)
  deletedAt    DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User?    // Link to main User entity

  @@index([telegramId])
  @@index([centerId])
  @@index([userStep])
  @@index([isDeleted])
  @@map("telegram_users")
}

// Center Telegram Bot - Har bir center uchun bot ma'lumotlari
model CenterTelegramBot {
  id          Int      @id @default(autoincrement())
  centerId    Int
  botToken    String   @unique
  botUsername String?
  displayName String?
  isActive    Boolean  @default(true)
  
  // Webhook configuration
  webhookUrl   String?
  secretToken  String   @unique
  webhookSetAt DateTime?
  
  // Bot messages
  welcomeMessage      String?  @db.Text
  courseInfoTemplate  String?  @db.Text
  paymentInstruction  String?  @db.Text
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  center Center @relation(fields: [centerId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([secretToken])
  @@index([isDeleted])
  @@map("center_telegram_bots")
}

// Student Bot State - Student bot conversation state tracking
model StudentBotState {
  id              Int      @id @default(autoincrement())
  telegramUserId  Int
  centerId        Int
  
  // Current step in enrollment flow
  currentStep     String   // "contact_shared", "enter_name", "select_group", "select_payment", "waiting_receipt", "completed"
  
  // Selected data
  groupId         Int?
  selectedMonths  Int?     // Number of months for payment
  paymentId       Int?     // Associated payment record
  
  // User provided data
  contactShared   Boolean  @default(false)
  studentName     String?
  
  // Additional metadata (JSON)
  metadata        Json?    // Store any additional state data
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([telegramUserId, centerId])
  @@index([telegramUserId])
  @@index([centerId])
  @@index([currentStep])
  @@index([isDeleted])
  @@map("student_bot_states")
}

// Center Payment Cards - O'quv markaz to'lov kartalari
model CenterPaymentCard {
  id         Int      @id @default(autoincrement())
  centerId   Int
  
  // Karta ma'lumotlari
  cardNumber String   // Masalan: "8600 1234 5678 9012"
  cardHolder String   // Masalan: "FALCON ACADEMY LLC"
  bankName   String?  // Masalan: "Uzcard", "Humo", "Visa"
  cardType   String?  @default("uzcard") // uzcard, humo, visa, mastercard
  
  // Status va sozlamalar
  isActive   Boolean  @default(true)
  isVisible  Boolean  @default(true)  // Admin bu kartani ko'rsatish/yashirish
  isPrimary  Boolean  @default(false) // Asosiy karta (default sifatida ko'rsatiladi)
  
  // Qo'shimcha ma'lumot
  description String?  @db.Text // Masalan: "Asosiy karta", "Muddatli to'lovlar uchun"
  displayOrder Int?    @default(0) // Kartalar tartibini belgilash
  
  // Soft delete
  isDeleted  Boolean  @default(false)
  deletedAt  DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  center Center @relation(fields: [centerId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([isVisible])
  @@index([isPrimary])
  @@index([isDeleted])
  @@map("center_payment_cards")
}

// Tarif rejalar (Plans)
model Plan {
  id            Int      @id @default(autoincrement())
  key           String   @unique
  name          String
  description   String?
  monthlyPrice  Int
  currency      String   @default("USD")
  maxStudents   Int?
  maxTeachers   Int?
  maxGroups     Int?
  maxCenters    Int?
  featuresJson  String?
  isActive      Boolean  @default(true)
  
  // Soft delete
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  subscriptions CenterSubscription[]

  @@index([isDeleted])
  @@map("plans")
}

// Center Subscription - Obuna ma'lumotlari
model CenterSubscription {
  id                     Int                @id @default(autoincrement())
  centerId               Int
  planId                 Int
  status                 SubscriptionStatus @default(ACTIVE)
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  cancelAtPeriodEnd      Boolean            @default(false)
  externalCustomerId     String?
  externalSubscriptionId String?
  
  // Soft delete
  isDeleted              Boolean            @default(false)
  deletedAt              DateTime?
  
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  // Relations
  center Center @relation(fields: [centerId], references: [id], onDelete: Cascade)
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@index([centerId])
  @@index([planId])
  @@index([status])
  @@index([isDeleted])
  @@map("center_subscriptions")
}

// Subscription Status Enum
enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
}

// User Type Enum
enum UserType {
  ADMIN      // System administrator
  TEACHER    // O'qituvchi
  STUDENT    // O'quvchi
  PARENT     // Ota-ona (optional, future use)
}

// SMS Verification - Vaqtincha saqlash uchun
model SmsVerification {
  id          Int      @id @default(autoincrement())
  phoneNumber String   @unique
  code        String
  payload     Json     // Ro'yxatdan o'tish ma'lumotlari (Center name, user info, etc.)
  attempts    Int      @default(0)
  expiresAt   DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("sms_verifications")
}

// UserCenter - User va Center o'rtasidagi many-to-many relationship
model UserCenter {
  id        Int      @id @default(autoincrement())
  userId    Int
  centerId  Int
  role      UserType // Bu centerda qanday rol (ADMIN, TEACHER, STUDENT)
  isActive  Boolean  @default(true)
  
  // Soft delete
  isDeleted Boolean  @default(false)
  deletedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  center Center @relation(fields: [centerId], references: [id], onDelete: Cascade)

  @@unique([userId, centerId])
  @@index([userId])
  @@index([centerId])
  @@index([isDeleted])
  @@map("user_centers")
}

// ============================================
// EDUCATION CRM - GROUP & PAYMENT MANAGEMENT
// ============================================

// Teacher model - O'qituvchilar
model Teacher {
  id          Int      @id @default(autoincrement())
  centerId    Int
  userId      Int      // Required link to User table (for Telegram notifications)
  
  // Teacher information (denormalized from User for performance)
  firstName   String?
  lastName    String?
  specialty   String?  // Mutaxassisligi
  bio         String?  @db.Text
  
  // Status
  isActive    Boolean  @default(true)
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupTeachers GroupTeacher[]

  @@index([centerId])
  @@index([userId])
  @@index([isDeleted])
  @@map("teachers")
}

// Student model - O'quvchilar
model Student {
  id          Int      @id @default(autoincrement())
  centerId    Int
  userId      Int      // Required link to User table (added via Telegram)
  
  // Student information (denormalized from User for performance)
  firstName   String?
  lastName    String?
  
  // Status
  isActive    Boolean  @default(true)
  
  // Soft delete
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments    Enrollment[]
  payments       Payment[]
  freezeRequests StudentFreeze[]
  refundRequests RefundRequest[]

  @@index([centerId])
  @@index([userId])
  @@index([isDeleted])
  @@map("students")
}

// Group model - Guruhlar
model Group {
  id              Int      @id @default(autoincrement())
  centerId        Int
  
  // Group information
  name            String
  description     String?  @db.Text
  monthlyPrice    Decimal  @db.Decimal(10, 2)  // Base monthly price
  
  // Course dates
  courseStartDate DateTime
  courseEndDate   DateTime
  
  // Payment configuration
  paymentType     PaymentType  // MONTHLY_SAME_DATE, START_TO_END_OF_MONTH, LESSON_BASED
  
  // For LESSON_BASED payment type
  lessonsPerPaymentPeriod Int?  // Bir to'lov davridagi darslar soni
  
  // Join link (generated only after successful /connect)
  joinLink        String?  @unique  // Telegram orqali ulashish uchun link
  
  // Telegram group connection
  telegramGroupId String?  @unique  // Connected Telegram group chat ID
  
  // Connect token for initial Telegram setup (one-time use)
  connectToken        String?   @unique  // Secret token for /connect command
  connectTokenExpires DateTime?          // Token expiration timestamp
  
  // Status
  status          GroupStatus @default(PENDING)  // PENDING, ACTIVE, INACTIVE
  isActive        Boolean  @default(true)
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  groupTeachers   GroupTeacher[]
  groupDiscounts  GroupDiscount[]  // Multi-month discount configurations
  enrollments     Enrollment[]
  lessonSchedules LessonSchedule[]
  payments        Payment[]

  @@index([centerId])
  @@index([joinLink])
  @@index([status])
  @@index([telegramGroupId])
  @@index([connectToken])
  @@index([isDeleted])
  @@map("groups")
}

// GroupTeacher - Guruh va o'qituvchilar o'rtasidagi many-to-many
model GroupTeacher {
  id        Int      @id @default(autoincrement())
  groupId   Int
  teacherId Int
  
  // Role in this group
  isPrimary Boolean  @default(false)  // Asosiy o'qituvchi
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([groupId, teacherId])
  @@index([groupId])
  @@index([teacherId])
  @@map("group_teachers")
}

// LessonSchedule - Dars jadvali
model LessonSchedule {
  id        Int      @id @default(autoincrement())
  groupId   Int
  
  // Day of week (1 = Monday, 7 = Sunday)
  dayOfWeek Int
  
  // Lesson time
  startTime String   // Format: "HH:MM" (e.g., "09:00")
  endTime   String   // Format: "HH:MM" (e.g., "10:30")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@map("lesson_schedules")
}

// GroupDiscount - Multi-month upfront payment discounts
model GroupDiscount {
  id             Int      @id @default(autoincrement())
  groupId        Int
  
  // Discount configuration
  months         Int      // Number of months (e.g., 2, 3, 6)
  discountAmount Decimal  @db.Decimal(10, 2)  // Fixed discount amount (e.g., 200000 UZS)
  
  // Soft delete
  isDeleted      Boolean  @default(false)
  deletedAt      DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, months])
  @@index([groupId])
  @@index([isDeleted])
  @@map("group_discounts")
}

// Enrollment - Student enrollment in a group with balance and pricing tracking
model Enrollment {
  id              Int      @id @default(autoincrement())
  groupId         Int
  studentId       Int
  
  // Enrollment information
  joinedAt        DateTime @default(now())      // When student clicked join link
  lessonStartDate DateTime?                     // When lessons actually start (set by admin, used for proration)
  
  // Status
  status          EnrollmentStatus @default(LEAD)  // ACTIVE, FROZEN, EXPELLED, COMPLETED, DROPPED
  
  // Balance tracking
  balance         Decimal  @db.Decimal(10, 2) @default(0.00)  // Positive = overpaid, Negative = debt
  
  // Discount configuration (individual student discount - FIXED AMOUNT)
  individualDiscountAmount Decimal @db.Decimal(10, 2) @default(0.00)  // Fixed discount amount per month (e.g., 50000 UZS)
  isRecurringDiscount      Boolean @default(true)   // true = monthly recurring, false = one-time (uses discountValidUntil)
  isFreeEnrollment         Boolean @default(false)  // Student doesn't pay (explicit flag for clarity)
  
  // Per-lesson pricing
  baseLessonPrice Decimal  @db.Decimal(10, 2)  // Lesson price from group (before individual discount)
  perLessonPrice  Decimal  @db.Decimal(10, 2)  // Current effective price per lesson (after discounts)
  
  // Discount validity (for multi-month prepaid or temporary discounts)
  discountValidUntil DateTime?  // When the special discount expires
  
  // Payment tracking
  lastPaymentDate DateTime?
  nextPaymentDate DateTime?
  
  // Upfront payment tracking
  paidUpfrontMonths Int?     // Number of months paid upfront
  upfrontValidUntil DateTime? // When upfront payment period ends
  
  // Removal tracking
  removedAt       DateTime?
  removalReason   String?  // AUTO_NONPAYMENT, MANUAL, STUDENT_REQUEST, etc.
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  group          Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student        Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  freezeRequests StudentFreeze[]

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@index([status])
  @@index([balance])
  @@index([nextPaymentDate])
  @@index([discountValidUntil])
  @@index([isDeleted])
  @@map("enrollments")
}

// Payment - To'lovlar
model Payment {
  id              Int      @id @default(autoincrement())
  centerId        Int
  groupId         Int
  studentId       Int
  enrollmentId    Int?     // Link to Enrollment
  
  // Payment information
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("UZS")
  
  // Payment period (recommended for tracking coverage)
  periodStart     DateTime?
  periodEnd       DateTime?
  
  // Payment type for this specific payment
  paymentType     PaymentType?
  
  // For LESSON_BASED payments
  lessonsIncluded Int?     // Bu to'lovga nechta dars kiradi
  lessonPrice     Decimal? @db.Decimal(10, 2)  // Bir dars narxi
  lessonsInPeriod Int?     // Total lessons in this payment period (for refund calculations)
  lessonsMissed   Int?     // Lessons already passed before student joined (proration)
  discountApplied Decimal? @db.Decimal(10, 2)  // Discount amount applied at payment time (audit trail)
  isProrated      Boolean  @default(false)     // True if this is a prorated first payment (mid-course join)
  
  // Status
  status          PaymentStatus @default(PENDING)  // PENDING, PAID, OVERDUE, CANCELLED, REFUNDED
  
  // Payment dates
  dueDate         DateTime?
  paidAt          DateTime?
  
  // Payment method
  paymentMethod   String?  // CASH, CARD, CLICK, PAYME, etc.
  
  // Notification tracking
  notificationSent Boolean  @default(false)
  notificationSentAt DateTime?
  
  // Overdue tracking
  overdueNoticeSent Boolean @default(false)
  overdueNoticeSentAt DateTime?
  daysOverdue     Int      @default(0)
  
  // Notes
  notes           String?  @db.Text
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([groupId])
  @@index([studentId])
  @@index([enrollmentId])
  @@index([status])
  @@index([dueDate])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([isDeleted])
  @@map("payments")
}

// StudentFreeze - Talabani muzlatish
model StudentFreeze {
  id              Int      @id @default(autoincrement())
  enrollmentId    Int
  studentId       Int
  
  // Freeze information
  reason          String   @db.Text
  freezeStartDate DateTime
  freezeEndDate   DateTime?  // null = indefinite freeze
  
  // Status
  status          FreezeStatus @default(ACTIVE)  // ACTIVE, ENDED, CANCELLED
  
  // End tracking
  actualEndDate   DateTime?
  endedBy         String?  // STUDENT, ADMIN, AUTO
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([studentId])
  @@index([status])
  @@index([freezeStartDate])
  @@index([isDeleted])
  @@map("student_freezes")
}

// RefundRequest - Qaytarish so'rovi
model RefundRequest {
  id              Int      @id @default(autoincrement())
  centerId        Int
  studentId       Int
  groupId         Int
  
  // Refund information
  requestReason   String   @db.Text
  totalPaid       Decimal  @db.Decimal(10, 2)  // Jami to'langan summa
  lessonsAttended Int      // Qatnashgan darslar soni
  totalLessons    Int      // Jami darslar soni
  
  // Calculated refund
  refundAmount    Decimal  @db.Decimal(10, 2)  // Qaytariladigan summa
  
  // Status
  status          RefundStatus @default(PENDING)  // PENDING, APPROVED, REJECTED, COMPLETED
  
  // Processing
  processedBy     Int?     // Admin user ID
  processedAt     DateTime?
  processingNotes String?  @db.Text
  
  // Completion
  completedAt     DateTime?
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([centerId])
  @@index([studentId])
  @@index([groupId])
  @@index([status])
  @@index([isDeleted])
  @@map("refund_requests")
}

// PaymentNotification - To'lov haqida xabarnomalar
model PaymentNotification {
  id              Int      @id @default(autoincrement())
  centerId        Int
  studentId       Int
  paymentId       Int?
  
  // Notification information
  notificationType NotificationType  // PAYMENT_DUE, PAYMENT_OVERDUE, PAYMENT_REMINDER
  
  // Message
  message         String   @db.Text
  
  // Delivery
  deliveryMethod  String   // TELEGRAM, SMS, EMAIL
  deliveryStatus  DeliveryStatus @default(PENDING)  // PENDING, SENT, FAILED, DELIVERED
  
  // Tracking
  sentAt          DateTime?
  deliveredAt     DateTime?
  failureReason   String?
  
  // Retry
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([centerId])
  @@index([studentId])
  @@index([paymentId])
  @@index([deliveryStatus])
  @@index([sentAt])
  @@map("payment_notifications")
}

// PaymentSchedule - To'lov jadvali (future payments)
model PaymentSchedule {
  id              Int      @id @default(autoincrement())
  centerId        Int
  groupId         Int
  studentId       Int
  groupStudentId  Int
  
  // Schedule information
  scheduledDate   DateTime  // Qachon to'lov kutilmoqda
  amount          Decimal   @db.Decimal(10, 2)
  
  // Period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Status
  status          ScheduleStatus @default(SCHEDULED)  // SCHEDULED, GENERATED, CANCELLED
  
  // Generated payment tracking
  paymentId       Int?      // Generated payment ID
  generatedAt     DateTime?
  
  // Soft delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([centerId])
  @@index([groupId])
  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
  @@index([isDeleted])
  @@map("payment_schedules")
}

// ============================================
// ENUMS
// ============================================

enum PaymentType {
  MONTHLY_SAME_DATE        // From start date to same date next month
  START_TO_END_OF_MONTH    // From start to end of month, then full months
  LESSON_BASED             // Based on number of lessons
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum EnrollmentStatus {
  LEAD       // Joined via link, waiting for admin to activate
  ACTIVE
  FROZEN
  EXPELLED
  COMPLETED
  DROPPED
}

enum FreezeStatus {
  ACTIVE
  ENDED
  CANCELLED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum NotificationType {
  PAYMENT_DUE
  PAYMENT_OVERDUE
  PAYMENT_REMINDER
  FREEZE_APPROVED
  FREEZE_ENDED
  REFUND_PROCESSED
  GROUP_REMOVED
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
}

enum ScheduleStatus {
  SCHEDULED
  GENERATED
  CANCELLED
}

enum GroupStatus {
  PENDING   // Waiting for Telegram group connection
  ACTIVE    // Connected to Telegram and active
  INACTIVE  // Deactivated
}

